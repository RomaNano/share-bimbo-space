Прекращение выполнения горутины с помощью функции отмены
Представленный код относится к подходу с использованием канала для передачи сигнала отмены (в данном случае — пустого структурного канала).

Рассмотрим пример прекращение выполнения горутины с помощью функции. 

Функцию отмены нужно вызвать после выполнения цикла for:

func countTo(max int) (<-chan int, func()) {
    ch := make(chan int)
    done := make(chan struct{})
    
    cancel := func() {
        close(done)
    }

    go func() {
        for i := 0; i < max; i++ {
            select {
            case <-done:
                return
            default:
                ch <- i
            }
        }
        close(ch)
    }()

    return ch, cancel
}

func main() {
    ch, cancel := countTo(10)
    for i := range ch {
        if i > 5 {
            break
        }
        fmt.Println(i)
    }
    cancel()
}

                  
Данный код содержит функцию countTo, которая принимает на вход число и возвращает канал значений типа int и функцию cancel.

Функция countTo запускает горутину, которая с помощью цикла отправляет значения в канал ch до достижения числа max. При каждой итерации цикла происходит проверка наличия сигнала в канале done, если сигнал есть, функция countTo закрывает канал ch и прекращает свое выполнение.  

Функция cancel создает канал типа struct{} и закрывает его, что приводит к закрытию канала done. Это означает, что при следующей проверке условия case <- done: горутина выйдет из цикла и завершится.

В функции main происходит вызов функции countTo и передача значения 10 в качестве значения переменной max. Затем осуществляется итерация по значениям, полученным из канала ch. Если значение больше 5, происходит вызов функции cancel, что приводит к завершению горутины.
